<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Magnetar - Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#C00000">
  <meta name="description" content="Magnetar - Profile">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Magnetar">
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --magnetar-red: #C00000;
      --text-dark: #1A1A1A;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      color: var(--text-dark);
      background-color: #f7f7f7;
      -webkit-tap-highlight-color: transparent;
    }
    
    h1, h2, h3, h4, h5, h6, .heading {
      font-family: 'Roboto', sans-serif;
    }
    
    .btn-primary {
      background-color: var(--magnetar-red);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .btn-primary:hover, .btn-primary:active {
      background-color: #A00000;
      transform: translateY(-1px);
    }
    
    .btn-primary:active {
      transform: translateY(1px);
    }
    
    /* Custom input styles */
    input, textarea, select {
      background-color: #f5f5f5 !important;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none !important;
      background-color: #f0f0f0 !important;
      box-shadow: 0 0 0 2px rgba(192, 0, 0, 0.2) !important;
    }
    
    .card {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .card:hover {
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-3px);
    }
    
    /* Page transition animation */
    .page-transition {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid rgba(192, 0, 0, 0.1);
      border-top-color: var(--magnetar-red);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Active nav item */
    .nav-item.active {
      color: var(--magnetar-red);
    }
    
    /* Prevent zoom */
    * {
      touch-action: manipulation;
    }
  </style>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDtNedkJo6ikNneZZdrheiWbE3Dn2B8kwQ",
      authDomain: "ces-project-f8b4e.firebaseapp.com",
      databaseURL: "https://ces-project-f8b4e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ces-project-f8b4e",
      storageBucket: "ces-project-f8b4e.firebasestorage.app",
      messagingSenderId: "580767851656",
      appId: "1:580767851656:web:2c852e7edb81a6decdeb3d",
      measurementId: "G-K73DSMWBTP"
    };
    
    // Add page transition animation
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('page-transition');
    });
    
    // Prevent zoom on double-tap
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    // Prevent zoom on pinch
    document.addEventListener('touchmove', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    // Prevent zoom on double-tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  </script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-100 min-h-screen pb-16">
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Header -->
  <header class="bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
    <div class="flex items-center">
      <img 
        src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/20250127_191600_0000-6AwFlDvh6mQeKcJJwH3Jlyef5Qpeic.png" 
        alt="Magnetar Logo" 
        class="w-8 h-8 mr-2"
      />
      <h1 class="text-xl font-bold">Profile</h1>
    </div>
    <div class="flex space-x-2">
      <button class="p-2 rounded-full hover:bg-gray-100">
        <span class="material-icons text-gray-600">edit</span>
      </button>
      <button class="p-2 rounded-full hover:bg-gray-100">
        <span class="material-icons text-gray-600">settings</span>
      </button>
    </div>
  </header>
  
  <main class="container mx-auto px-4 py-6 pb-24 max-w-lg">
    <!-- Profile Header -->
    <div class="bg-white rounded-lg shadow-sm mb-6 p-6 text-center">
      <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
        <span class="material-icons text-gray-400 text-5xl">person</span>
        <!-- User photo would go here -->
      </div>
      <h2 class="text-2xl font-bold">User Name</h2>
      <p class="text-gray-600">user@example.com</p>
      
      <div class="mt-4 flex justify-center space-x-4">
        <a href="affiliate.html" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center">
          <span class="material-icons mr-1 text-sm">share</span>
          Affiliate
        </a>
        <button class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg flex items-center">
          <span class="material-icons mr-1 text-sm">logout</span>
          Logout
        </button>
      </div>
    </div>
    
    <!-- Profile content would go here -->
    <div class="space-y-6">
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-4">Account Information</h3>
        <p>Profile content coming soon...</p>
      </div>
    </div>
  </main>
  
  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pt-2 pb-safe z-10">
    <div class="flex justify-around items-center">
      <a href="dashboard.html" class="flex flex-col items-center p-2 text-gray-600 nav-item">
        <span class="material-icons">home</span>
        <span class="text-xs mt-1">Home</span>
      </a>
      <a href="marketplace.html" class="flex flex-col items-center p-2 text-gray-600 nav-item">
        <span class="material-icons">storefront</span>
        <span class="text-xs mt-1">Market</span>
      </a>
      <a href="apps.html" class="flex flex-col items-center p-2 text-gray-600 nav-item">
        <span class="material-icons">apps</span>
        <span class="text-xs mt-1">Apps</span>
      </a>
      <a href="network.html" class="flex flex-col items-center p-2 text-gray-600 nav-item">
        <span class="material-icons">group</span>
        <span class="text-xs mt-1">Network</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center p-2 text-red-600 nav-item active">
        <span class="material-icons">person</span>
        <span class="text-xs mt-1">Profile</span>
      </a>
    </div>
  </nav>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="displayName">Display Name</label>
                        <input type="text" id="displayName" name="displayName" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label for="bioText">Bio</label>
                        <textarea id="bioText" name="bioText" placeholder="Tell us about yourself" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profilePicture">Profile Picture</label>
                        <div class="file-input-container">
                            <button type="button" class="file-input-button">Choose File</button>
                            <span class="file-name">No file chosen</span>
                            <input type="file" id="profilePicture" name="profilePicture" accept="image/*" hidden>
                        </div>
                    </div>
                    <button type="submit" class="primary-button">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // DOM Elements
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileBio = document.getElementById('profileBio');
        const postsCount = document.getElementById('postsCount');
        const followersCount = document.getElementById('followersCount');
        const followingCount = document.getElementById('followingCount');
        const userPosts = document.getElementById('userPosts');
        const userMedia = document.getElementById('userMedia');
        const userLikes = document.getElementById('userLikes');
        const editProfileModal = document.getElementById('editProfileModal');
        const editProfileForm = document.getElementById('editProfileForm');
        const editProfileBtn = document.querySelector('.edit-profile-btn');
        const closeModalBtn = document.querySelector('.close-modal');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Check if user is logged in
        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserProfile(user);
                loadUserPosts(user.uid);
                loadUserMedia(user.uid);
                loadUserLikes(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });
        
        // Load user profile data
        function loadUserProfile(user) {
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        
                        // Set profile name and email
                        profileName.textContent = userData.displayName || user.displayName || 'User';
                        profileEmail.textContent = userData.email || user.email || '';
                        
                        // Set profile bio if exists
                        if (userData.bio) {
                            profileBio.textContent = userData.bio;
                        }
                        
                        // Set profile avatar
                        if (userData.photoURL) {
                            profileAvatar.innerHTML = `<img src="${userData.photoURL}" alt="Profile Picture">`;
                        } else {
                            const initials = (userData.displayName || user.displayName || 'User')
                                .split(' ')
                                .map(name => name.charAt(0))
                                .join('')
                                .toUpperCase();
                            
                            profileAvatar.textContent = initials;
                            profileAvatar.style.backgroundColor = getRandomColor(user.uid);
                        }
                        
                        // Set form values for editing
                        document.getElementById('displayName').value = userData.displayName || user.displayName || '';
                        document.getElementById('bioText').value = userData.bio || '';
                        
                        // Set stats
                        if (userData.stats) {
                            postsCount.textContent = userData.stats.posts || 0;
                            followersCount.textContent = userData.stats.followers || 0;
                            followingCount.textContent = userData.stats.following || 0;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user profile:', error);
                });
        }
        
        // Load user posts
        function loadUserPosts(userId) {
            userPosts.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            
            db.collection('posts')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    userPosts.innerHTML = '';
                    
                    if (snapshot.empty) {
                        userPosts.innerHTML = '<div class="empty-state">No posts yet</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const postElement = createPostElement(post, doc.id);
                        userPosts.appendChild(postElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading user posts:', error);
                    userPosts.innerHTML = '<div class="error-state">Failed to load posts</div>';
                });
        }
        
        // Load user media (posts with images or videos)
        function loadUserMedia(userId) {
            userMedia.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            
            db.collection('posts')
                .where('userId', '==', userId)
                .where('hasMedia', '==', true)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get()
                .then(snapshot => {
                    userMedia.innerHTML = '';
                    
                    if (snapshot.empty) {
                        userMedia.innerHTML = '<div class="empty-state">No media yet</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        
                        if (post.image) {
                            mediaItem.innerHTML = `<img src="${post.image}" alt="Post image">`;
                        } else if (post.video) {
                            mediaItem.innerHTML = `
                                <div class="video-thumbnail">
                                    <img src="${post.videoThumbnail || '/placeholder.svg?height=200&width=200'}" alt="Video thumbnail">
                                    <div class="play-icon"><i class="fas fa-play"></i></div>
                                </div>
                            `;
                        }
                        
                        mediaItem.addEventListener('click', () => {
                            // Open media in modal or redirect to post
                            window.location.href = `post.html?id=${doc.id}`;
                        });
                        
                        userMedia.appendChild(mediaItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading user media:', error);
                    userMedia.innerHTML = '<div class="error-state">Failed to load media</div>';
                });
        }
        
        // Load posts liked by user
        function loadUserLikes(userId) {
            userLikes.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            
            db.collection('users').doc(userId).collection('likes')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        userLikes.innerHTML = '<div class="empty-state">No liked posts yet</div>';
                        return;
                    }
                    
                    const likedPostIds = snapshot.docs.map(doc => doc.id);
                    
                    if (likedPostIds.length === 0) {
                        userLikes.innerHTML = '<div class="empty-state">No liked posts yet</div>';
                        return;
                    }
                    
                    // We need to fetch posts in batches since we can't use "in" with more than 10 items
                    const batches = [];
                    for (let i = 0; i < likedPostIds.length; i += 10) {
                        const batch = likedPostIds.slice(i, i + 10);
                        batches.push(batch);
                    }
                    
                    userLikes.innerHTML = '';
                    
                    // Process each batch
                    batches.forEach(batch => {
                        db.collection('posts')
                            .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                            .get()
                            .then(postsSnapshot => {
                                postsSnapshot.forEach(doc => {
                                    const post = doc.data();
                                    const postElement = createPostElement(post, doc.id);
                                    userLikes.appendChild(postElement);
                                });
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading liked posts:', error);
                    userLikes.innerHTML = '<div class="error-state">Failed to load liked posts</div>';
                });
        }
        
        // Create post element
        function createPostElement(post, postId) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.dataset.id = postId;
            
            const userInitials = post.userInitials || (post.user ? post.user.initials : '');
            const userName = post.userDisplayName || (post.user ? post.user.name : 'User');
            const userId = post.userId || (post.user ? post.user.uid : '');
            const timestamp = post.timestamp ? new Date(post.timestamp.seconds * 1000) : new Date();
            const timeAgo = getTimeAgo(timestamp);
            
            let mediaHtml = '';
            if (post.image) {
                mediaHtml = `<div class="post-image"><img src="${post.image}" alt="Post image"></div>`;
            } else if (post.video) {
                mediaHtml = `
                    <div class="post-video">
                        <video controls>
                            <source src="${post.video}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            }
            
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="post-user">
                        <div class="user-avatar" style="background-color: ${getRandomColor(userId)}">${userInitials}</div>
                        <div class="user-info">
                            <div class="user-name">${userName}</div>
                            <div class="post-time">${timeAgo}</div>
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    <p>${post.content || ''}</p>
                    ${mediaHtml}
                </div>
                <div class="post-actions">
                    <button class="action-button like-button ${post.liked ? 'liked' : ''}">
                        <i class="fas fa-heart"></i>
                        <span>${post.likes || 0}</span>
                    </button>
                    <button class="action-button comment-button">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments ? (Array.isArray(post.comments) ? post.comments.length : post.comments) : 0}</span>
                    </button>
                    <button class="action-button share-button">
                        <i class="fas fa-share"></i>
                    </button>
                </div>
            `;
            
            // Add event listeners for post actions
            const likeButton = postElement.querySelector('.like-button');
            likeButton.addEventListener('click', () => {
                toggleLike(postId, likeButton);
            });
            
            return postElement;
        }
        
        // Toggle like on a post
        function toggleLike(postId, button) {
            const userId = auth.currentUser.uid;
            const likeRef = db.collection('users').doc(userId).collection('likes').doc(postId);
            const postRef = db.collection('posts').doc(postId);
            
            db.runTransaction(transaction => {
                return transaction.get(likeRef).then(likeDoc => {
                    return transaction.get(postRef).then(postDoc => {
                        if (!postDoc.exists) {
                            throw "Post does not exist!";
                        }
                        
                        const postData = postDoc.data();
                        const currentLikes = postData.likes || 0;
                        
                        if (likeDoc.exists) {
                            // User already liked the post, so unlike it
                            transaction.delete(likeRef);
                            transaction.update(postRef, { likes: currentLikes - 1 });
                            button.classList.remove('liked');
                            button.querySelector('span').textContent = currentLikes - 1;
                        } else {
                            // User hasn't liked the post, so like it
                            transaction.set(likeRef, { 
                                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                            });
                            transaction.update(postRef, { likes: currentLikes + 1 });
                            button.classList.add('liked');
                            button.querySelector('span').textContent = currentLikes + 1;
                        }
                    });
                });
            }).catch(error => {
                console.error("Error toggling like:", error);
            });
        }
        
        // Get random color based on user ID
        function getRandomColor(userId) {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA5A5', '#A5FFD6',
                '#FFC145', '#FF6B8B', '#C04CFD', '#47C1FF', '#FFD166'
            ];
            
            // Use the user ID to deterministically select a color
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }
        
        // Format timestamp to time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return '1 day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return '1 minute ago';
            
            if (seconds < 10) return 'just now';
            
            return Math.floor(seconds) + ' seconds ago';
        }
        
        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked button and corresponding content
                button.classList.add('active');
                const tabName = button.dataset.tab;
                document.getElementById(`${tabName}-content`).classList.add('active');
            });
        });
        
        // Edit profile modal
        editProfileBtn.addEventListener('click', () => {
            editProfileModal.style.display = 'flex';
        });
        
        closeModalBtn.addEventListener('click', () => {
            editProfileModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === editProfileModal) {
                editProfileModal.style.display = 'none';
            }
        });
        
        // File input handling
        const fileInput = document.getElementById('profilePicture');
        const fileButton = document.querySelector('.file-input-button');
        const fileName = document.querySelector('.file-name');
        
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
            } else {
                fileName.textContent = 'No file chosen';
            }
        });
        
        // Handle profile edit form submission
        editProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) return;
            
            const displayName = document.getElementById('displayName').value;
            const bio = document.getElementById('bioText').value;
            const profilePicture = document.getElementById('profilePicture').files[0];
            
            // Show loading state
            const submitButton = editProfileForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;
            
            // Update profile data
            const userRef = db.collection('users').doc(user.uid);
            
            // If there's a new profile picture, upload it first
            let updatePromise;
            
            if (profilePicture) {
                const storageRef = storage.ref(`profile_pictures/${user.uid}`);
                updatePromise = storageRef.put(profilePicture)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(downloadURL => {
                        return userRef.update({
                            displayName,
                            bio,
                            photoURL: downloadURL,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
            } else {
                updatePromise = userRef.update({
                    displayName,
                    bio,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            updatePromise
                .then(() => {
                    // Update auth profile
                    return user.updateProfile({
                        displayName
                    });
                })
                .then(() => {
                    // Reload user profile
                    loadUserProfile(user);
                    
                    // Close modal
                    editProfileModal.style.display = 'none';
                    
                    // Show success message
                    alert('Profile updated successfully!');
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    alert('Failed to update profile. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                });
        });
    </script>
</body>
</html>
